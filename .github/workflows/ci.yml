---
#####################################################################################################################################################################################################
# Project:       Juniper
# Application:   juniper-ml
# File Name:     ci.yml
# Author:        Paul Calnon
# Version:       0.3.0
#
# Date Created:  2026-02-23
# Last Modified: 2026-02-25
#
# License:       MIT License
# Copyright:     Copyright (c) 2024-2026 Paul Calnon
#
# Description:
#    GitHub Actions CI/CD Pipeline for juniper-ml meta-package.
#    - Build and validate (twine check)
#    - Documentation link validation
#    - Dependency documentation generation
#
#####################################################################################################################################################################################################

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  PYTHON_TEST_VERSION: "3.12"

jobs:
  # ═══════════════════════════════════════════════════════════════════════════════════════════════
  # Build: Build the package and validate with twine
  # ═══════════════════════════════════════════════════════════════════════════════════════════════
  build:
    name: Build and Validate Package
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405  # v6.2.0
        with:
          python-version: ${{ env.PYTHON_TEST_VERSION }}

      - name: Install build tools
        run: pip install build twine

      - name: Build package
        run: python -m build

      - name: Validate package
        run: twine check dist/*

      - name: Verify installable (editable)
        run: pip install -e .

      - name: Verify extras metadata is declared
        # Sub-packages (juniper-data-client etc.) are not yet on PyPI, so
        # extras can't be installed. Verify the extras are declared in metadata.
        run: |
          python -c "
          import importlib.metadata
          meta = importlib.metadata.metadata('juniper-ml')
          extras = importlib.metadata.requires('juniper-ml') or []
          print('Declared extras:', meta.get_all('Provides-Extra'))
          print('Requirements:', extras)
          assert 'clients' in (meta.get_all('Provides-Extra') or []), 'clients extra missing'
          assert 'worker' in (meta.get_all('Provides-Extra') or []), 'worker extra missing'
          print('All extras verified.')
          "

      - name: Upload dist
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08  # v4.6.0
        with:
          name: dist
          path: dist/
          retention-days: 7

  # ═══════════════════════════════════════════════════════════════════════════════════════════════
  # Docs: Validate documentation link integrity
  # ═══════════════════════════════════════════════════════════════════════════════════════════════
  docs:
    name: Documentation Links
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
      - uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405  # v6.2.0
        with:
          python-version: ${{ env.PYTHON_TEST_VERSION }}
      - name: Validate Documentation Links
        run: python scripts/check_doc_links.py --exclude templates --exclude history

  # ═══════════════════════════════════════════════════════════════════════════════════════════════
  # Dependency Documentation: Generate pip dependency records
  # ═══════════════════════════════════════════════════════════════════════════════════════════════
  dependency-docs:
    name: Dependency Documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Set up Python ${{ env.PYTHON_TEST_VERSION }}
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405  # v6.2.0
        with:
          python-version: ${{ env.PYTHON_TEST_VERSION }}
          cache: pip

      - name: Install project dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Generate Dependency Documentation
        run: |
          echo "╔════════════════════════════════════════════════════════════╗"
          echo "║       juniper-ml - Dependency Documentation                ║"
          echo "╚════════════════════════════════════════════════════════════╝"
          bash scripts/generate_dep_docs.sh

      - name: Upload Dependency Documentation
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08  # v4.6.0
        if: always()
        with:
          name: dependency-docs
          path: |
            conf/requirements_ci.txt
            conf/requirements_ci_*.txt
          retention-days: 90

  # ═══════════════════════════════════════════════════════════════════════════════════════════════
  # Quality Gate: All required checks must pass
  # ═══════════════════════════════════════════════════════════════════════════════════════════════
  required-checks:
    name: Quality Gate
    runs-on: ubuntu-latest
    if: always()
    needs: [build, docs, dependency-docs]
    steps:
      - name: Check Quality Gate Status
        run: |
          echo "Build:            ${{ needs.build.result }}"
          echo "Docs:             ${{ needs.docs.result }}"
          echo "Dependency Docs:  ${{ needs.dependency-docs.result }}"

          if [[ "${{ needs.build.result }}" != "success" ]]; then
            echo "::error::Package build/validation failed"
            exit 1
          fi
          if [[ "${{ needs.docs.result }}" != "success" ]]; then
            echo "::error::Documentation link validation failed"
            exit 1
          fi

          echo "::notice::Quality Gate PASSED ✓"
